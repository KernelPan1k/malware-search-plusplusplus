// original : https://addons.mozilla.org/fr/firefox/addon/malware-search-plusplus/

browser.contextMenus.create({
  id: "malware-search-list-bc",
  title: "Bleeping Computer",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-startup",
  title: "Startup List",
  parentId: "malware-search-list-bc",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-uninstall",
  title: "Uninstall List",
  parentId: "malware-search-list-bc",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-file",
  title: "File Database",
  parentId: "malware-search-list-bc",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl",
  title: "SystemLookup",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl-filename",
  title: "Filename",
  parentId: "malware-search-list-sl",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl-clsid",
  title: "CLSID",
  parentId: "malware-search-list-sl",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl-name",
  title: "Name",
  parentId: "malware-search-list-sl",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-whois",
  title: "Whois",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-processLib",
  title: "Process Library",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-ms",
  title: "Microsoft Threat Encyclopedia",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-hpHosts",
  title: "hpHosts",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-virustotal",
  title: "Search hash in VirusTotal",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-ipleak",
  title: "Search IP address in ipleak.net",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-search-engine",
  title: "Search engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-tuxMaster",
  title: "TuxMaster's Custom Google Search",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyGoogle",
  title: "Google",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyBing",
  title: "Bing",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyDuckDuckGo",
  title: "DukDuckGo",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyStartPage",
  title: "StartPage",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

// Function to run when clicked
browser.contextMenus.onClicked.addListener((info, tab) => {
  let baseURL = null;

  // Replace \ with \\
  function replaceSlashes(str) {
    console.log('orig: ' + str);
    const news = str.replace(/\\/g, "\\\\");
    console.log('new: ' + news);
    return news;
  }

  function cpToClipBoard(info) {
    const code = "copyToClipboard('" + replaceSlashes(info.selectionText) + "');";

    browser.tabs.executeScript({
      code: "typeof copyToClipboard == 'function';"
    }).then((results) => {
      // If the above is false, we need to run clipboard.js so the function is defined
      if (!results || results[0] !== true) {
        return browser.tabs.executeScript(tab.id, {
          file: "clipboard.js"
        });
      }
    }).then(() => {
      // After we have made sure the function is defined, we can run it
      return browser.tabs.executeScript(tab.id, {
        code: code
      });
    }).catch((error) => {
      // Display an error if one occurs
      console.log("Failed to copy text: " + error);
    });
  }

  function openNewTabWithSearchTerm(baseURL, info) {
    cpToClipBoard(info);
    // URL with search term
    const selectionText = info.selectionText || '';
    const searchURL = baseURL + selectionText.trim();

    browser.tabs.create({
      active: true,
      url: searchURL
    });
  }

  switch (info.menuItemId) {
    case "malware-search-list-sl-filename":
      baseURL = "http://www.systemlookup.com/search.php?type=filename&search=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-sl-clsid":
      baseURL = "http://www.systemlookup.com/search.php?type=clsid&search=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-sl-name":
      baseURL = "http://www.systemlookup.com/search.php?type=name&search=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-whois":
      baseURL = "https://who.is/whois-ip/ip-address/";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-processLib":
      baseURL = "http://www.processlibrary.com/en/search/?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-ms":
      baseURL = "https://www.microsoft.com/en-us/wdsi/threats/threat-search?page=1&showall=false&sortby=date&sortdir=desc&size=10&query=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-hpHosts":
      baseURL = "http://hosts-file.net/default.asp?s=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-tuxMaster":
      baseURL = "https://cse.google.com/cse?cx=000803903574434752404%3Aznxwnaiatxq&sa=Search&cof=FORID%3A1&ie=utf-8&oe=utf-8&q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-startup":
      baseURL = "http://www.bleepingcomputer.com/startups/?act=search&st=0&keyword=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-uninstall":
      baseURL = "http://www.bleepingcomputer.com/uninstall/?act=search&st=0&keyword=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-file":
      baseURL = "http://www.bleepingcomputer.com/filedb/?act=search&st=0&keyword=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-virustotal":
      baseURL = "https://www.virustotal.com/#/search/";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-ipleak":
      baseURL = "https://ipleak.net/?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyGoogle":
      baseURL = "https://www.google.com/search?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyBing":
      baseURL = "https://www.bing.com/search?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyDuckDuckGo":
      baseURL = "https://duckduckgo.com/?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyStartPage":
      baseURL = "https://www.startpage.com/do/dsearch?query=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
  }
});
