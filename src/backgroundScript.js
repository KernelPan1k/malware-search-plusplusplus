// original : https://addons.mozilla.org/fr/firefox/addon/malware-search-plusplus/

browser.contextMenus.create({
  id: "malware-search-list-bc",
  title: "bleepingcomputer.com",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-startup",
  title: browser.i18n.getMessage("StartupList"),
  parentId: "malware-search-list-bc",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-uninstall",
  title:  browser.i18n.getMessage("UninstallList"),
  parentId: "malware-search-list-bc",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-file",
  title: browser.i18n.getMessage("FileDatabase"),
  parentId: "malware-search-list-bc",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl",
  title: "systemlookup.com",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl-filename",
  title: browser.i18n.getMessage("Filename"),
  parentId: "malware-search-list-sl",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl-clsid",
  title: "CLSID",
  parentId: "malware-search-list-sl",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl-name",
  title: browser.i18n.getMessage("Name"),
  parentId: "malware-search-list-sl",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-whois",
  title: "whois",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-processLib",
  title: browser.i18n.getMessage("ProcessLibrary"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-ms",
  title: browser.i18n.getMessage("MicrosoftThreatEncyclopedia"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-hpHosts",
  title: browser.i18n.getMessage("HostsFile"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-site-analyze",
  title: browser.i18n.getMessage("SiteAnalyze"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-virustotal",
  title: browser.i18n.getMessage("VirusTotal"),
  parentId: "malware-search-site-analyze",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-virscanhash",
  title: browser.i18n.getMessage("VirscanHash"),
  parentId: "malware-search-site-analyze",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-virscanfile",
  title: browser.i18n.getMessage("VirscanFile"),
  parentId: "malware-search-site-analyze",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-hybrid-analysis",
  title: browser.i18n.getMessage("HybridAnalysis"),
  parentId: "malware-search-site-analyze",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-ipleak",
  title: browser.i18n.getMessage("IpLeak"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-search-engine",
  title: browser.i18n.getMessage("SearchEngine"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyGoogle",
  title: "Google",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyBing",
  title: "Bing",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyDuckDuckGo",
  title: "DukDuckGo",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyStartPage",
  title: "StartPage",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-custom-google",
  title: browser.i18n.getMessage("CustomGoogleSearch"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-kernelpanik",
  title: browser.i18n.getMessage("KernelPanikSearch"),
  parentId: "malware-search-list-custom-google",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-tuxMaster",
  title: "TuxMaster's",
  parentId: "malware-search-list-custom-google",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-av-definition",
  title: browser.i18n.getMessage("AvDefinitions"),
  parentId: "malware-search-list-custom-google",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-malware-sample-definition",
  title: browser.i18n.getMessage("MalwareSampleSubmissions"),
  parentId: "malware-search-list-custom-google",
  contexts: ["selection"]
});

// Function to run when clicked
browser.contextMenus.onClicked.addListener((info, tab) => {
  let baseURL = null;

  // Replace \ with \\
  function replaceSlashes(str) {
    console.log('orig: ' + str);
    const news = str.replace(/\\/g, "\\\\");
    console.log('new: ' + news);
    return news;
  }

  function cpToClipBoard(info) {
    const code = "copyToClipboard('" + replaceSlashes(info.selectionText) + "');";

    browser.tabs.executeScript({
      code: "typeof copyToClipboard == 'function';"
    }).then((results) => {
      // If the above is false, we need to run clipboard.js so the function is defined
      if (!results || results[0] !== true) {
        return browser.tabs.executeScript(tab.id, {
          file: "clipboard.js"
        });
      }
    }).then(() => {
      // After we have made sure the function is defined, we can run it
      return browser.tabs.executeScript(tab.id, {
        code: code
      });
    }).catch((error) => {
      // Display an error if one occurs
      console.log(browser.i18n.getMessage("ClipboardFail") + error);
    });
  }

  function openNewTabWithSearchTerm(baseURL, info) {
    cpToClipBoard(info);
    // URL with search term
    const selectionText = info.selectionText || '';
    let searchURL;

    if (-1 === baseURL.indexOf("__SEARCH__")) {
      searchURL = baseURL + selectionText.trim();
    } else {
      searchURL = baseURL.replace("__SEARCH__", selectionText.trim());
    }

    browser.tabs.create({
      active: true,
      url: searchURL
    });
  }

  switch (info.menuItemId) {
    case "malware-search-list-sl-filename":
      baseURL = "http://www.systemlookup.com/search.php?type=filename&search=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-sl-clsid":
      baseURL = "http://www.systemlookup.com/search.php?type=clsid&search=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-sl-name":
      baseURL = "http://www.systemlookup.com/search.php?type=name&search=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-whois":
      baseURL = "https://who.is/whois-ip/ip-address/";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-processLib":
      baseURL = "http://www.processlibrary.com/en/search/?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-ms":
      baseURL = "https://www.microsoft.com/en-us/wdsi/threats/threat-search?page=1&showall=false&sortby=date&sortdir=desc&size=10&query=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-hpHosts":
      baseURL = "http://hosts-file.net/default.asp?s=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-kernelpanik":
      baseURL = "https://cse.google.fr/cse?cx=018216496857092257319:wrwvn1pyvbm&q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-tuxMaster":
      baseURL = "https://cse.google.com/cse?cx=000803903574434752404%3Aznxwnaiatxq&sa=Search&cof=FORID%3A1&ie=utf-8&oe=utf-8&q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-av-definition":
      baseURL = "https://cse.google.co.uk/cse?cx=003089153695915392663:3aeplrxqc1q&q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-malware-sample-definition":
      baseURL = "https://cse.google.co.uk/cse?cx=003089153695915392663:yi7j3xmja0w&q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-startup":
      baseURL = "http://www.bleepingcomputer.com/startups/?act=search&st=0&keyword=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-uninstall":
      baseURL = "http://www.bleepingcomputer.com/uninstall/?act=search&st=0&keyword=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-file":
      baseURL = "http://www.bleepingcomputer.com/filedb/?act=search&st=0&keyword=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-virustotal":
      baseURL = "https://www.virustotal.com/#/search/";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-virscanhash":
      baseURL = "http://md5.virscan.org/language/en/";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-virscanfile":
      baseURL = "http://f.virscan.org/language/fr/__SEARCH__.html";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-hybrid-analysis":
      baseURL = "https://www.hybrid-analysis.com/search?query=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-ipleak":
      baseURL = "https://ipleak.net/?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyGoogle":
      baseURL = "https://www.google.com/search?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyBing":
      baseURL = "https://www.bing.com/search?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyDuckDuckGo":
      baseURL = "https://duckduckgo.com/?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyStartPage":
      baseURL = "https://www.startpage.com/do/dsearch?query=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
  }
});
