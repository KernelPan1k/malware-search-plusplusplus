// original : https://addons.mozilla.org/fr/firefox/addon/malware-search-plusplus/

browser.contextMenus.create({
  id: "malware-search-list-bc",
  title: "bleepingcomputer.com",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-startup",
  title: browser.i18n.getMessage("StartupList"),
  parentId: "malware-search-list-bc",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-uninstall",
  title: browser.i18n.getMessage("UninstallList"),
  parentId: "malware-search-list-bc",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-file",
  title: browser.i18n.getMessage("FileDatabase"),
  parentId: "malware-search-list-bc",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-mcafee",
  title: "mcafee.com",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-mcafee-name",
  title: browser.i18n.getMessage("Name"),
  parentId: "malware-search-list-mcafee",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-mcafee-dns",
  title: browser.i18n.getMessage("Dns"),
  parentId: "malware-search-list-mcafee",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-mcafee-ip",
  title: browser.i18n.getMessage("IP"),
  parentId: "malware-search-list-mcafee",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-mcafee-domain",
  title: browser.i18n.getMessage("Domain"),
  parentId: "malware-search-list-mcafee",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl",
  title: "systemlookup.com",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl-filename",
  title: browser.i18n.getMessage("Filename"),
  parentId: "malware-search-list-sl",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl-clsid",
  title: "CLSID",
  parentId: "malware-search-list-sl",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-sl-name",
  title: browser.i18n.getMessage("Name"),
  parentId: "malware-search-list-sl",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-kp",
  title: "kernel-panik.me",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-kp-filename",
  title: browser.i18n.getMessage("Filename"),
  parentId: "malware-search-list-kp",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-kp-md5",
  title: "MD5",
  parentId: "malware-search-list-kp",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-whois",
  title: "whois",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-processLib",
  title: browser.i18n.getMessage("ProcessLibrary"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-ms",
  title: browser.i18n.getMessage("MicrosoftThreatEncyclopedia"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-hpHosts",
  title: browser.i18n.getMessage("HostsFile"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-site-analyze",
  title: browser.i18n.getMessage("SiteAnalyze"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-virustotal",
  title: browser.i18n.getMessage("VirusTotal"),
  parentId: "malware-search-site-analyze",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-virscanhash",
  title: browser.i18n.getMessage("VirscanHash"),
  parentId: "malware-search-site-analyze",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-virscanfile",
  title: browser.i18n.getMessage("VirscanFile"),
  parentId: "malware-search-site-analyze",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-bc-hybrid-analysis",
  title: browser.i18n.getMessage("HybridAnalysis"),
  parentId: "malware-search-site-analyze",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-ipleak",
  title: browser.i18n.getMessage("IpLeak"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-search-engine",
  title: browser.i18n.getMessage("SearchEngine"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyGoogle",
  title: "Google",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyBing",
  title: "Bing",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyDuckDuckGo",
  title: "DukDuckGo",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-copyStartPage",
  title: "StartPage",
  parentId: "malware-search-search-engine",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-custom-google",
  title: browser.i18n.getMessage("CustomGoogleSearch"),
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-kernelpanik",
  title: browser.i18n.getMessage("KernelPanikSearch"),
  parentId: "malware-search-list-custom-google",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-tuxMaster",
  title: "TuxMaster's",
  parentId: "malware-search-list-custom-google",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-av-definition",
  title: browser.i18n.getMessage("AvDefinitions"),
  parentId: "malware-search-list-custom-google",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-search-list-malware-sample-definition",
  title: browser.i18n.getMessage("MalwareSampleSubmissions"),
  parentId: "malware-search-list-custom-google",
  contexts: ["selection"]
});

browser.contextMenus.create({
  id: "malware-studio",
  title: "Malware analyze",
  contexts: ["all"]
});

// Function to run when clicked
browser.contextMenus.onClicked.addListener((info, tab) => {
  let baseURL = null;

  // Replace \ with \\
  function replaceSlashes(str) {
    console.log('orig: ' + str);
    const news = str.replace(/\\/g, "\\\\");
    console.log('new: ' + news);
    return news;
  }

  function cpToClipBoard(selectionText) {
    const code = "copyToClipboard('" + replaceSlashes(selectionText) + "');";

    browser.tabs.executeScript({
      code: "typeof copyToClipboard == 'function';"
    }).then((results) => {
      if (!results || results[0] !== true) {
        return browser.tabs.executeScript(tab.id, {
          file: "clipboard.js"
        });
      }
    }).then(() => {
      return browser.tabs.executeScript(tab.id, {
        code: code
      });
    }).catch((error) => {
      console.log(browser.i18n.getMessage("ClipboardFail") + error);
    });
  }

  function openNewTabWithSearchTerm(baseURL, info) {
    const selectionText = (info.selectionText || '').trim();
    let searchURL;

    cpToClipBoard(selectionText);

    if (-1 !== baseURL.indexOf("__SEARCH__")) {
      searchURL = baseURL.replace("__SEARCH__", selectionText);
    } else {
      searchURL = baseURL + selectionText;
    }

    browser.tabs.create({
      active: true,
      url: searchURL
    });
  }

  function handleError(error) {
    console.log(`Error: ${ error }`);

    browser.notifications.create({
      "type": "basic",
      "title": "Error",
      "message": error.message || "Unknown error"
    });
  }

  const openNewTabStudio = (content) => {
    var creating = browser.tabs.create({active: true, url: "studio/app.html"});

    creating.then((tab) => {
      setTimeout(() => {
        // TODO Remove the setTimeout
        browser.tabs.sendMessage(tab.id, {content: content}).then(() => null, handleError);
      }, 500);
    }, handleError);
  };

  const handleContent = (response) => new Promise((resolve, reject) => {
    if (!response || !response.getContent) {
      reject(new Error("Unknown Content"));
    }

    resolve(response.getContent);
  });

  const getTheContent = (tab) => browser.tabs.sendMessage(tab.id, {getContent: true});

  const getCurrentTab = () => browser.tabs.query({currentWindow: true, active: true});

  const isValidTab = (tabs) => new Promise((resolve, reject) => {
    try {
      if (/file:\/\/\/.+\.txt$/.test(tabs[0].url)) {
        resolve(tabs[0]);
      }

      reject(new Error("You must open page file:///*.txt"));

    } catch (e) {
      reject(e);
    }
  });

  const openStudio = () => {
    return getCurrentTab()
    .then(isValidTab)
    .then(getTheContent)
    .then(handleContent)
    .then(openNewTabStudio)
    .catch(handleError)
  };

  switch (info.menuItemId) {
    case "malware-search-list-sl-filename":
      baseURL = "http://www.systemlookup.com/search.php?type=filename&search=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-sl-clsid":
      baseURL = "http://www.systemlookup.com/search.php?type=clsid&search=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-sl-name":
      baseURL = "http://www.systemlookup.com/search.php?type=name&search=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-kp-filename":
      baseURL = "https://kernel-panik.me/database/files/?file_name=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-kp-md5":
      baseURL = "https://kernel-panik.me/database/files/?md5=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-whois":
      baseURL = "https://who.is/whois-ip/ip-address/";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-processLib":
      baseURL = "http://www.processlibrary.com/en/search/?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-ms":
      baseURL = "https://www.microsoft.com/en-us/wdsi/threats/threat-search?page=1&showall=false&sortby=date&sortdir=desc&size=10&query=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-hpHosts":
      baseURL = "http://hosts-file.net/default.asp?s=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-kernelpanik":
      baseURL = "https://cse.google.fr/cse?cx=018216496857092257319:wrwvn1pyvbm&q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-tuxMaster":
      baseURL = "https://cse.google.com/cse?cx=000803903574434752404%3Aznxwnaiatxq&sa=Search&cof=FORID%3A1&ie=utf-8&oe=utf-8&q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-av-definition":
      baseURL = "https://cse.google.co.uk/cse?cx=003089153695915392663:3aeplrxqc1q&q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-malware-sample-definition":
      baseURL = "https://cse.google.co.uk/cse?cx=003089153695915392663:yi7j3xmja0w&q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-startup":
      baseURL = "http://www.bleepingcomputer.com/startups/?act=search&st=0&keyword=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-uninstall":
      baseURL = "http://www.bleepingcomputer.com/uninstall/?act=search&st=0&keyword=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-file":
      baseURL = "http://www.bleepingcomputer.com/filedb/?act=search&st=0&keyword=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-virustotal":
      baseURL = "https://www.virustotal.com/#/search/";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-virscanhash":
      baseURL = "http://md5.virscan.org/language/en/";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-virscanfile":
      baseURL = "http://f.virscan.org/language/fr/__SEARCH__.html";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-bc-hybrid-analysis":
      baseURL = "https://www.hybrid-analysis.com/search?query=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-ipleak":
      baseURL = "https://ipleak.net/?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyGoogle":
      baseURL = "https://www.google.com/search?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyBing":
      baseURL = "https://www.bing.com/search?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyDuckDuckGo":
      baseURL = "https://duckduckgo.com/?q=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-copyStartPage":
      baseURL = "https://www.startpage.com/do/dsearch?query=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-mcafee-name":
      baseURL = "https://www.mcafee.com/enterprise/fr-fr/search/threat.html?q=__SEARCH__&v=malware";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-mcafee-dns":
      baseURL = "https://www.mcafee.com/enterprise/fr-fr/threat-intelligence.dnstc.html?vid=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-mcafee-ip":
      baseURL = "https://www.mcafee.com/enterprise/fr-fr/threat-intelligence.iptc.html?vid=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-search-list-mcafee-domain":
      baseURL = "https://www.mcafee.com/enterprise/fr-fr/threat-intelligence.domaintc.html?vid=";
      openNewTabWithSearchTerm(baseURL, info);
      break;
    case "malware-studio":
      openStudio();
      break;
  }
});
